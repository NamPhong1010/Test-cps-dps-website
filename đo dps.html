<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mouse DPS / CPS Tester</title>
  <style>
    :root{--bg:#0b1220;--pane:#071421;--accent:#22c55e;--muted:#9fb0c8}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071428,#0b1220);color:#e6f0fb}
    .wrap{width:980px;max-width:96%;padding:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 8px 40px rgba(0,0,0,0.6);display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media(max-width:900px){.card{grid-template-columns:1fr;}}
    h1{margin:0;font-size:18px}
    .left{display:flex;flex-direction:column;gap:12px}

    .click-zone{height:420px;border-radius:10px;background:linear-gradient(180deg,#082433,#042230);display:flex;align-items:center;justify-content:center;flex-direction:column;user-select:none}
    .click-btn{width:320px;height:120px;border-radius:12px;border:3px solid rgba(255,255,255,0.04);font-size:28px;background:linear-gradient(180deg,#0ea46a,#0b8f53);color:white;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .click-btn:active{transform:translateY(2px)}
    .small{color:var(--muted);font-size:13px}

    .right{display:flex;flex-direction:column;gap:10px}
    .stat{background:var(--pane);padding:12px;border-radius:8px}
    .stat big{display:block;font-size:36px;color:var(--accent)}

    #graph{width:100%;height:140px;background:transparent;border-radius:6px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:#0b1622;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:#e6eef8;font-weight:700;cursor:pointer}
    button.secondary{background:transparent}
    footer{font-size:13px;color:var(--muted);text-align:center;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="left">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h1>Mouse DPS / CPS Tester</h1>
          <div class="small">Nhấn vào vùng lớn để bắt đầu đếm. Hỗ trợ chuột và cảm ứng.</div>
        </div>

        <div class="click-zone" id="zone">
          <div class="click-btn" id="clickBtn">CLICK / TAP</div>
          <div class="small" style="margin-top:8px">Lần nhấp: <strong id="total">0</strong> · Thời gian: <strong id="elapsed">0.00</strong>s</div>
        </div>

        <div>
          <canvas id="graph" aria-hidden="true"></canvas>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="start">Bắt đầu (Reset)</button>
          <button id="pause" class="secondary">Tạm dừng</button>
          <button id="export" class="secondary">Xuất CSV</button>
          <label style="align-self:center" class="small">Interval (ms): <input id="interval" type="number" value="1000" min="100" step="100" style="width:100px;margin-left:6px"></label>
        </div>
      </div>

      <div class="right">
        <div class="stat">
          <div class="small">CPS (hiện tại)</div>
          <big id="cps">0.00</big>
        </div>

        <div class="stat">
          <div class="small">CPS (trung bình phiên)</div>
          <big id="avg">0.00</big>
        </div>

        <div class="stat">
          <div class="small">Đỉnh (peak CPS)</div>
          <big id="peak">0.00</big>
        </div>

        <div class="stat">
          <div class="small">Phân loại nút</div>
          <div style="margin-top:8px">Left: <strong id="leftCount">0</strong> · Right: <strong id="rightCount">0</strong> · Middle: <strong id="midCount">0</strong></div>
        </div>

        <div class="stat">
          <div class="small">Ghi chú</div>
          <div class="small" style="margin-top:6px">Đếm dựa trên <em>mốc thời gian</em> (interval) — mặc định 1000 ms. Thay đổi interval để đo DPS ổn định hơn hoặc nhanh hơn.</div>
        </div>
      </div>
    </div>

    <footer>2024 Nam Phong. All reserved.</footer>
  </div>

<script>
  // State
  const zone = document.getElementById('zone');
  const clickBtn = document.getElementById('clickBtn');
  const totalEl = document.getElementById('total');
  const elapsedEl = document.getElementById('elapsed');
  const cpsEl = document.getElementById('cps');
  const avgEl = document.getElementById('avg');
  const peakEl = document.getElementById('peak');
  const leftCountEl = document.getElementById('leftCount');
  const rightCountEl = document.getElementById('rightCount');
  const midCountEl = document.getElementById('midCount');
  const intervalInput = document.getElementById('interval');

  const startBtn = document.getElementById('start');
  const pauseBtn = document.getElementById('pause');
  const exportBtn = document.getElementById('export');
  const graph = document.getElementById('graph');
  const gctx = graph.getContext('2d');

  let started = false;
  let paused = false;
  let startTime = 0;
  let totalClicks = 0;
  let left = 0, right = 0, mid = 0;

  // For interval-based CPS: keep counts per interval in a sliding window
  let intervalMs = Number(intervalInput.value);
  let intervalTimer = null;
  let bucketCount = 0; // clicks in current bucket
  let history = []; // array of CPS values (per interval)
  let peak = 0;

  // Resize graph to CSS size * DPR
  function resizeGraph(){
    const rect = graph.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    graph.width = Math.floor(rect.width * dpr);
    graph.height = Math.floor(rect.height * dpr);
    gctx.setTransform(dpr,0,0,dpr,0,0);
    drawGraph();
  }
  window.addEventListener('resize', resizeGraph);

  function drawGraph(){
    const w = graph.width / (window.devicePixelRatio||1);
    const h = graph.height / (window.devicePixelRatio||1);
    gctx.clearRect(0,0,w,h);
    // background
    gctx.fillStyle = 'rgba(255,255,255,0.03)';
    gctx.fillRect(0,0,w,h);
    if(history.length === 0) return;
    // find max
    const max = Math.max(...history, 1);
    const pad = 8;
    const step = (w - pad*2) / (history.length - 1 || 1);
    gctx.beginPath();
    for(let i=0;i<history.length;i++){
      const x = pad + i*step;
      const y = h - pad - (history[i]/max) * (h - pad*2);
      if(i===0) gctx.moveTo(x,y); else gctx.lineTo(x,y);
    }
    gctx.lineWidth = 2;
    gctx.strokeStyle = '#22c55e';
    gctx.stroke();
    // fill under curve
    gctx.lineTo(pad + (history.length-1)*step, h-pad);
    gctx.lineTo(pad, h-pad);
    gctx.closePath();
    gctx.fillStyle = 'rgba(34,197,94,0.12)';
    gctx.fill();
  }

  function startSession(){
    // reset
    started = true; paused = false;
    startTime = performance.now();
    totalClicks = 0; left = 0; right = 0; mid = 0;
    bucketCount = 0; history = []; peak = 0;
    updateDisplays();
    clearInterval(intervalTimer);
    intervalMs = Number(intervalInput.value) || 1000;
    intervalTimer = setInterval(onInterval, intervalMs);
    resizeGraph();
  }

  function pauseSession(){
    paused = !paused;
    if(paused){ clearInterval(intervalTimer); pauseBtn.textContent = 'Tiếp tục'; }
    else { intervalMs = Number(intervalInput.value) || 1000; intervalTimer = setInterval(onInterval, intervalMs); pauseBtn.textContent = 'Tạm dừng'; }
  }

  function stopSession(){
    started = false; paused = false;
    clearInterval(intervalTimer);
  }

  function onInterval(){
    // compute CPS for last interval (clicks per second)
    const cps = bucketCount / (intervalMs / 1000);
    history.push(Number(cps.toFixed(2)));
    if(history.length > 60) history.shift();
    if(cps > peak) peak = cps;
    bucketCount = 0;
    updateDisplays();
    drawGraph();
  }

  function updateDisplays(){
    totalEl.textContent = totalClicks;
    const elapsed = started ? (performance.now() - startTime) / 1000 : 0;
    elapsedEl.textContent = elapsed.toFixed(2);
    const avg = elapsed > 0 ? (totalClicks / elapsed) : 0;
    avgEl.textContent = avg.toFixed(2);
    cpsEl.textContent = (history.length ? history[history.length-1].toFixed(2) : '0.00');
    peakEl.textContent = peak.toFixed(2);
    leftCountEl.textContent = left;
    rightCountEl.textContent = right;
    midCountEl.textContent = mid;
  }

  // handle clicks
  function registerClick(btn){
    if(!started){ startSession(); }
    if(paused) return;
    totalClicks++;
    bucketCount++;
    if(btn === 0) left++;
    if(btn === 2) right++;
    if(btn === 1) mid++;
    updateDisplays();
  }

  // mouse and touch
  clickBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); registerClick(e.button); });
  clickBtn.addEventListener('mouseup', (e)=>{ e.preventDefault(); });
  // right-click should not open context menu inside zone
  clickBtn.addEventListener('contextmenu', (e)=>{ e.preventDefault(); registerClick(2); });

  // touch
  clickBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); registerClick(0); });

  // also allow clicking anywhere in zone
  zone.addEventListener('mousedown', (e)=>{ if(e.target === clickBtn) return; e.preventDefault(); registerClick(e.button); });
  zone.addEventListener('touchstart', (e)=>{ if(e.target === clickBtn) return; e.preventDefault(); registerClick(0); });

  // UI buttons
  startBtn.addEventListener('click', ()=>{ stopSession(); startSession(); });
  pauseBtn.addEventListener('click', ()=>{ if(!started) return; pauseSession(); });
  intervalInput.addEventListener('change', ()=>{
    intervalMs = Number(intervalInput.value) || 1000;
    if(started && !paused){ clearInterval(intervalTimer); intervalTimer = setInterval(onInterval, intervalMs); }
  });

  exportBtn.addEventListener('click', ()=>{
    // build CSV of timestamp,cps
    const rows = [];
    let time = 0;
    rows.push(['time_s','cps']);
    for(const v of history){ rows.push([time.toFixed(2), v]); time += intervalMs/1000; }
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'cps_history.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // animation update for elapsed and displays
  function rafUpdate(){ updateDisplays(); requestAnimationFrame(rafUpdate); }
  requestAnimationFrame(rafUpdate);
  resizeGraph();
</script>
</body>
</html>
